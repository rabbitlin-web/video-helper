<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°ç™½è§†é¢‘åŠ©æ‰‹ | å…è´¹è§†é¢‘ä¿®å¤å·¥å…·ç®±</title>
    <meta name="description" content="ä¸“ä¸ºæ–°æ‰‹è®¾è®¡çš„è§†é¢‘å·¥å…·ç®±ã€‚å…è´¹è½¬æ¢MP4ï¼Œå‹ç¼©è§†é¢‘å‘å¾®ä¿¡ï¼ŒHEICè½¬JPGã€‚ä¸ä¸Šä¼ æ–‡ä»¶ï¼Œä¿æŠ¤éšç§ã€‚">
    
    <script src="https://cdn.tailwindcss.com"></script>

    <script src="coi-serviceworker.js"></script>

    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.10.0/dist/ffmpeg.min.js"></script>

    <script src="https://unpkg.com/heic2any@0.0.3/dist/heic2any.min.js"></script>
    
    <style>
        body { background-color: #f2f2f2; color: #111; }
        
        /* æŒ‰é’®é£æ ¼ */
        .btn-tool { 
            transition: all 0.2s; 
            border: 2px solid #000; 
            background: #fff;
        }
        .btn-tool:hover { 
            transform: translate(-2px, -2px); 
            box-shadow: 4px 4px 0px #000; 
        }
        .btn-tool.active { 
            background: #000; 
            color: #fff; 
            box-shadow: 4px 4px 0px #666; 
            transform: translate(-2px, -2px);
        }

        /* é¢æ¿é£æ ¼ */
        .panel { 
            border: 2px solid #000; 
            background: #fff; 
            box-shadow: 8px 8px 0px rgba(0,0,0,0.1); 
        }

        /* è¾“å…¥æ¡†é£æ ¼ */
        .input-box { 
            border: 2px solid #ccc; 
            border-radius: 4px; 
            padding: 8px; 
            width: 100%; 
        }
        .input-box:focus { border-color: #000; outline: none; }
        
        /* åŠ è½½åœˆåœˆåŠ¨ç”» */
        .loader {
            border: 4px solid #f3f3f3; 
            border-top: 4px solid #000; 
            border-radius: 50%;
            width: 30px; 
            height: 30px; 
            animation: spin 1s linear infinite; 
            display: inline-block;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="font-sans antialiased min-h-screen flex flex-col">

    <header class="bg-white border-b-2 border-black p-6">
        <div class="max-w-6xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
            <div>
                <h1 class="text-3xl font-black tracking-tighter uppercase">VIDEO<span class="text-gray-500">HELPER</span></h1>
                <p class="text-sm font-bold text-gray-500 mt-1">ä¸æ‡‚ç”µè„‘ä¹Ÿèƒ½ç”¨çš„è§†é¢‘å·¥å…·ç®±</p>
            </div>
            <div class="text-xs font-mono bg-gray-100 px-3 py-1 border border-gray-300 rounded">
                éšç§ä¿æŠ¤ï¼šæ‰€æœ‰æ–‡ä»¶ä»…åœ¨æµè§ˆå™¨æœ¬åœ°å¤„ç†ï¼Œä¸ä¸Šä¼ æœåŠ¡å™¨ã€‚
            </div>
        </div>
    </header>

    <main class="flex-grow max-w-6xl mx-auto w-full p-6 grid grid-cols-1 md:grid-cols-4 gap-8">
        
        <aside class="md:col-span-1 space-y-3">
            <h3 class="font-bold text-gray-400 text-sm uppercase mb-4">é€‰æ‹©åŠŸèƒ½ / TOOLS</h3>
            
            <button onclick="switchTab('mp4')" id="btn-mp4" class="btn-tool active w-full py-4 px-4 text-left font-bold flex items-center justify-between">
                <span>ğŸ”„ è§†é¢‘è½¬ MP4</span> <span class="text-xs opacity-50">æœ€é€šç”¨</span>
            </button>
            
            <button onclick="switchTab('compress')" id="btn-compress" class="btn-tool w-full py-4 px-4 text-left font-bold flex items-center justify-between">
                <span>ğŸ“‰ å¾®ä¿¡è§†é¢‘å‹ç¼©</span> <span class="text-xs opacity-50">å‘ç»™è€æ¿</span>
            </button>
            
            <button onclick="switchTab('trim')" id="btn-trim" class="btn-tool w-full py-4 px-4 text-left font-bold flex items-center justify-between">
                <span>âœ‚ï¸ è§†é¢‘æå¤´å»å°¾</span> <span class="text-xs opacity-50">ç®€å•å‰ªè¾‘</span>
            </button>

            <button onclick="switchTab('audio')" id="btn-audio" class="btn-tool w-full py-4 px-4 text-left font-bold flex items-center justify-between">
                <span>ğŸµ æå–éŸ³é¢‘</span> <span class="text-xs opacity-50">è½¬MP3</span>
            </button>

            <button onclick="switchTab('heic')" id="btn-heic" class="btn-tool w-full py-4 px-4 text-left font-bold flex items-center justify-between">
                <span>ğŸ–¼ï¸ è‹¹æœå›¾ç‰‡è½¬æ¢</span> <span class="text-xs opacity-50">HEICè½¬JPG</span>
            </button>
        </aside>

        <section class="md:col-span-3">
            
            <div id="instruction-panel" class="mb-6 p-4 bg-gray-100 border-l-4 border-black text-sm text-gray-700">
                </div>

            <div class="panel p-8 min-h-[400px] flex flex-col justify-center items-center text-center relative">
                
                <div id="upload-zone" class="w-full">
                    <label class="block w-full border-2 border-dashed border-gray-300 hover:border-black hover:bg-gray-50 p-12 rounded-lg cursor-pointer transition">
                        <div class="text-4xl mb-2">ğŸ“‚</div>
                        <span class="font-bold text-lg">ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</span>
                        <p class="text-gray-400 text-sm mt-2" id="file-hint">æ”¯æŒ MOV, AVI, MKV, FLV ç­‰</p>
                        <input type="file" id="file-input" class="hidden">
                    </label>
                </div>

                <div id="options-zone" class="hidden w-full max-w-md mt-6 bg-gray-50 p-4 border border-gray-200 rounded text-left">
                    <div id="opt-trim" class="hidden grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-xs font-bold">å¼€å§‹æ—¶é—´ (ç§’)</label>
                            <input type="number" id="trim-start" value="0" class="input-box">
                        </div>
                        <div>
                            <label class="text-xs font-bold">ç»“æŸæ—¶é—´ (ç§’)</label>
                            <input type="number" id="trim-end" placeholder="ç•™ç©ºåˆ™åˆ°ç»“å°¾" class="input-box">
                        </div>
                        <p class="col-span-2 text-xs text-gray-500">æç¤ºï¼šå¦‚æœæƒ³ä»ç¬¬5ç§’å¼€å§‹ï¼Œå°±åœ¨å¼€å§‹æ—¶é—´å¡« 5ã€‚</p>
                    </div>
                </div>

                <div id="process-zone" class="hidden w-full">
                    <div class="loader mb-4"></div>
                    <h3 class="text-xl font-bold" id="status-text">æ­£åœ¨åˆå§‹åŒ–...</h3>
                    <p class="text-gray-500 text-sm mt-2">è¿™å¯èƒ½éœ€è¦ä¸€ç‚¹æ—¶é—´ï¼Œè¯·ä¸è¦å…³é—­ç½‘é¡µ</p>
                    <div class="w-full bg-gray-200 rounded-full h-2.5 mt-4">
                        <div class="bg-black h-2.5 rounded-full" style="width: 50%"></div>
                    </div>
                </div>

                <div id="result-zone" class="hidden w-full">
                    <div class="text-5xl mb-4">âœ…</div>
                    <h3 class="text-2xl font-bold mb-2">å¤„ç†å®Œæˆï¼</h3>
                    <div class="flex flex-col gap-3 justify-center mt-6">
                        <a id="download-link" href="#" class="bg-black text-white px-8 py-3 font-bold hover:bg-gray-800 transition rounded shadow-lg">
                            â¬‡ï¸ ä¸‹è½½æ–‡ä»¶
                        </a>
                        <button onclick="resetUI()" class="text-gray-500 underline text-sm">å¤„ç†ä¸‹ä¸€ä¸ª</button>
                    </div>
                </div>

                <div id="error-msg" class="hidden mt-4 bg-red-50 text-red-600 p-3 text-sm font-bold border border-red-200"></div>
                
                <button id="start-btn" class="hidden mt-6 bg-black text-white px-10 py-3 font-bold hover:bg-gray-800 w-full max-w-xs mx-auto">
                    å¼€å§‹å¤„ç†
                </button>

            </div>
        </section>
    </main>

    <footer class="text-center p-8 text-gray-400 text-xs">
        <p>GitHub Open Source Project | Designed for simplicity.</p>
    </footer>

    <script>
        const { createFFmpeg, fetchFile } = FFmpeg;
        // log: true æ–¹ä¾¿åœ¨æ§åˆ¶å°çœ‹åˆ°è¿›åº¦
        const ffmpeg = createFFmpeg({ log: true });
        
        let currentMode = 'mp4'; // é»˜è®¤æ¨¡å¼
        let selectedFile = null;

        // è·å–é¡µé¢å…ƒç´ 
        const els = {
            uploadZone: document.getElementById('upload-zone'),
            processZone: document.getElementById('process-zone'),
            resultZone: document.getElementById('result-zone'),
            optionsZone: document.getElementById('options-zone'),
            optTrim: document.getElementById('opt-trim'),
            fileInput: document.getElementById('file-input'),
            startBtn: document.getElementById('start-btn'),
            statusText: document.getElementById('status-text'),
            downloadLink: document.getElementById('download-link'),
            errorMsg: document.getElementById('error-msg'),
            instruction: document.getElementById('instruction-panel'),
            fileHint: document.getElementById('file-hint')
        };

        // è¯´æ˜ä¹¦æ–‡æ¡ˆé…ç½®
        const instructions = {
            mp4: `<strong>ğŸ“¢ è¿™ä¸ªåŠŸèƒ½åšä»€ä¹ˆï¼Ÿ</strong><br>å¸®ä½ è§£å†³â€œè§†é¢‘æ‰“ä¸å¼€â€æˆ–â€œæ ¼å¼ä¸æ”¯æŒâ€çš„é—®é¢˜ã€‚<br>ä¸ç®¡ä½ å½•çš„æ˜¯ MOV, MKV è¿˜æ˜¯å…¶ä»–å¥‡æ€ªæ ¼å¼ï¼Œç»Ÿç»Ÿè½¬æˆæœ€é€šç”¨çš„ MP4ã€‚`,
            compress: `<strong>ğŸ“¢ è¿™ä¸ªåŠŸèƒ½åšä»€ä¹ˆï¼Ÿ</strong><br>å¸®ä½ æŠŠå¤§è§†é¢‘å˜å°ï¼Œæ–¹ä¾¿å‘å¾®ä¿¡ã€å‘é‚®ä»¶ã€‚<br>æˆ‘ä»¬ä¼šç¨å¾®é™ä½ä¸€ç‚¹ç”»è´¨ï¼ˆè‚‰çœ¼å‡ ä¹çœ‹ä¸å‡ºï¼‰ï¼Œä½†èƒ½å¤§å¹…å‡å°æ–‡ä»¶ä½“ç§¯ã€‚`,
            trim: `<strong>ğŸ“¢ è¿™ä¸ªåŠŸèƒ½åšä»€ä¹ˆï¼Ÿ</strong><br>è§†é¢‘å¼€å¤´åœ¨è°ƒæ•´é•œå¤´ï¼Ÿç»“å°¾å¿˜äº†å…³æœºï¼Ÿ<br>åœ¨è¿™é‡Œè¾“å…¥ä½ æƒ³ä¿ç•™çš„æ—¶é—´æ®µï¼ŒæŠŠå¤šä½™çš„åºŸç‰‡åˆ‡æ‰ã€‚`,
            audio: `<strong>ğŸ“¢ è¿™ä¸ªåŠŸèƒ½åšä»€ä¹ˆï¼Ÿ</strong><br>åªè¦å£°éŸ³ï¼Œä¸è¦ç”»é¢ã€‚<br>æŠŠè§†é¢‘é‡Œçš„è®²è¯ã€éŸ³ä¹æå–å‡ºæ¥ï¼Œç”Ÿæˆ MP3 æ–‡ä»¶ã€‚`,
            heic: `<strong>ğŸ“¢ è¿™ä¸ªåŠŸèƒ½åšä»€ä¹ˆï¼Ÿ</strong><br>è§£å†³è‹¹æœæ‰‹æœºæ‹çš„ç…§ç‰‡ï¼ˆHEICæ ¼å¼ï¼‰åœ¨ç”µè„‘/å®‰å“ä¸Šæ‰“ä¸å¼€çš„é—®é¢˜ã€‚<br>ä¸€é”®è½¬æˆé€šç”¨çš„ JPG å›¾ç‰‡ã€‚`
        };

        // åˆå§‹åŒ–
        updateInstructions();

        // åˆ‡æ¢åŠŸèƒ½ Tab
        window.switchTab = (mode) => {
            currentMode = mode;
            // æŒ‰é’®æ ·å¼åˆ‡æ¢
            document.querySelectorAll('.btn-tool').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`btn-${mode}`).classList.add('active');
            
            resetUI();
            updateInstructions();
            
            // HEIC æ¨¡å¼åªæ¥å—å›¾ç‰‡ï¼Œå…¶ä»–æ¨¡å¼æ¥å—è§†é¢‘
            if (mode === 'heic') {
                els.fileInput.accept = "image/heic, image/heif";
                els.fileHint.innerText = "è¯·é€‰æ‹© .heic æˆ– .heif ç…§ç‰‡";
            } else {
                els.fileInput.accept = "video/*";
                els.fileHint.innerText = "æ”¯æŒ MOV, AVI, MKV, MP4 ç­‰";
            }
        };

        function updateInstructions() {
            els.instruction.innerHTML = instructions[currentMode];
            if(currentMode === 'trim') {
                els.optionsZone.classList.remove('hidden');
                els.optTrim.classList.remove('hidden');
            } else {
                els.optionsZone.classList.add('hidden');
                els.optTrim.classList.add('hidden');
            }
        }

        function resetUI() {
            selectedFile = null;
            els.fileInput.value = "";
            els.uploadZone.classList.remove('hidden');
            els.processZone.classList.add('hidden');
            els.resultZone.classList.add('hidden');
            els.startBtn.classList.add('hidden');
            els.errorMsg.classList.add('hidden');
        }

        // æ–‡ä»¶é€‰æ‹©ç›‘å¬
        els.fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            selectedFile = file;
            els.fileHint.innerHTML = `å·²é€‰æ‹©ï¼š<strong class="text-black">${file.name}</strong>`;
            els.startBtn.classList.remove('hidden');
        });

        // ç‚¹å‡»å¼€å§‹å¤„ç†
        els.startBtn.addEventListener('click', async () => {
            if (!selectedFile) return;

            // ç•Œé¢åˆ‡æ¢åˆ°åŠ è½½çŠ¶æ€
            els.uploadZone.classList.add('hidden');
            els.optionsZone.classList.add('hidden');
            els.startBtn.classList.add('hidden');
            els.processZone.classList.remove('hidden');
            els.errorMsg.classList.add('hidden');

            try {
                if (currentMode === 'heic') {
                    await processHEIC(selectedFile);
                } else {
                    await processVideo(selectedFile);
                }
            } catch (err) {
                console.error(err);
                els.processZone.classList.add('hidden');
                els.uploadZone.classList.remove('hidden');
                els.errorMsg.innerHTML = "å‡ºé”™äº†ï¼š<br>" + err.message + "<br><span class='text-xs font-normal'>å¦‚æœä½ çœ‹åˆ° SharedArrayBuffer é”™è¯¯ï¼Œè¯·ç¡®ä¿å·²æ­£ç¡®é…ç½® GitHub Pages æˆ– HTTPS ç¯å¢ƒã€‚</span>";
                els.errorMsg.classList.remove('hidden');
            }
        });

        // å›¾ç‰‡å¤„ç†é€»è¾‘
        async function processHEIC(file) {
            els.statusText.innerText = "æ­£åœ¨è½¬æ¢å›¾ç‰‡...";
            const blob = await heic2any({
                blob: file,
                toType: "image/jpeg",
                quality: 0.8
            });
            const url = URL.createObjectURL(blob);
            els.downloadLink.href = url;
            els.downloadLink.download = file.name.replace(/\.(heic|heif)$/i, "") + ".jpg";
            finishProcess();
        }

        // è§†é¢‘å¤„ç†é€»è¾‘
        async function processVideo(file) {
            if (!ffmpeg.isLoaded()) {
                els.statusText.innerText = "æ­£åœ¨åŠ è½½å¼•æ“ (é¦–æ¬¡éœ€å‡ åç§’)...";
                await ffmpeg.load();
            }

            const fileName = 'input_video';
            ffmpeg.FS('writeFile', fileName, await fetchFile(file));

            els.statusText.innerText = "æ­£åœ¨å¤„ç†ä¸­ï¼Œè¯·è€å¿ƒç­‰å¾…...";

            let command = [];
            const outputName = 'output.mp4';
            let finalOutput = outputName;

            // æ ¹æ®æ¨¡å¼ç”Ÿæˆ FFmpeg å‘½ä»¤
            if (currentMode === 'mp4') {
                command = ['-i', fileName, '-c:v', 'libx264', '-preset', 'ultrafast', '-c:a', 'aac', outputName];
            } 
            else if (currentMode === 'compress') {
                command = ['-i', fileName, '-vf', 'scale=-2:720', '-c:v', 'libx264', '-crf', '28', '-preset', 'ultrafast', '-c:a', 'aac', outputName];
            }
            else if (currentMode === 'audio') {
                finalOutput = 'output.mp3';
                command = ['-i', fileName, '-vn', '-acodec', 'libmp3lame', '-q:a', '2', finalOutput];
            }
            else if (currentMode === 'trim') {
                const start = document.getElementById('trim-start').value || 0;
                const end = document.getElementById('trim-end').value;
                command = ['-i', fileName, '-ss', start];
                if (end) command.push('-to', end);
                command.push('-c', 'copy', outputName);
            }

            await ffmpeg.run(...command);

            const data = ffmpeg.FS('readFile', finalOutput);
            const url = URL.createObjectURL(new Blob([data.buffer], { type: currentMode === 'audio' ? 'audio/mp3' : 'video/mp4' }));
            
            els.downloadLink.href = url;
            els.downloadLink.download = `fixed_${file.name.split('.')[0]}.${currentMode === 'audio' ? 'mp3' : 'mp4'}`;
            
            finishProcess();
        }

        function finishProcess() {
            els.processZone.classList.add('hidden');
            els.resultZone.classList.remove('hidden');
        }
    </script>
</body>
</html>