<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VideoHelper | å°ç™½è§†é¢‘åŠ©æ‰‹</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="coi-serviceworker.js"></script>
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.10.0/dist/ffmpeg.min.js"></script>
    <script src="https://unpkg.com/heic2any@0.0.3/dist/heic2any.min.js"></script>
    
    <style>
        /* å¼•å…¥æ›´å¥½çœ‹çš„è‹±æ–‡å­—ä½“ */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        
        body { 
            background-color: #F5F5F4; /* Stone-100: æ¸©æš–çš„ç±³ç°è‰²èƒŒæ™¯ */
            color: #44403C; /* Stone-700: æ·±ç°è¤æ–‡å­—ï¼Œä¸åˆºçœ¼ */
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
        }

        /* è«å…°è¿ªè‰²ç³»ç»„ä»¶ç±» */
        .morandi-card {
            background: #ffffff;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.03); /* ææ·¡çš„é˜´å½± */
            border: 1px solid #E7E5E4; /* Stone-200 */
        }

        /* å·¦ä¾§èœå•æŒ‰é’® */
        .nav-btn {
            display: flex;
            align-items: center;
            width: 100%;
            padding: 16px 20px;
            margin-bottom: 8px;
            border-radius: 12px;
            transition: all 0.3s ease;
            color: #78716C; /* Stone-500 */
            font-weight: 600;
            background: transparent;
        }
        
        .nav-btn:hover {
            background-color: #E7E5E4; /* Stone-200 */
            color: #44403C;
        }

        /* é€‰ä¸­çŠ¶æ€ï¼šé›¾éœ¾è“ */
        .nav-btn.active {
            background-color: #475569; /* Slate-600 */
            color: #ffffff;
            box-shadow: 0 4px 12px rgba(71, 85, 105, 0.2);
        }

        /* ä¸»æŒ‰é’®ï¼šé¼ å°¾è‰ç»¿ */
        .btn-primary {
            background-color: #709085; /* Morandi Green */
            color: white;
            transition: all 0.2s;
        }
        .btn-primary:hover {
            background-color: #5a756b;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(112, 144, 133, 0.3);
        }

        /* è™šçº¿ä¸Šä¼ æ¡† */
        .upload-box {
            border: 2px dashed #D6D3D1; /* Stone-300 */
            border-radius: 16px;
            transition: all 0.3s;
            background: #FAFAF9;
        }
        .upload-box:hover {
            border-color: #709085;
            background: #EFF6F3;
        }

        .loader { border: 3px solid #E7E5E4; border-top: 3px solid #709085; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <header class="bg-white/80 backdrop-blur-md border-b border-stone-200 sticky top-0 z-50">
        <div class="max-w-6xl mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-[#475569] rounded-lg flex items-center justify-center text-white font-bold text-lg">V</div>
                <div>
                    <h1 class="text-xl font-bold tracking-tight text-stone-800">VIDEO<span class="text-[#709085]">HELPER</span></h1>
                </div>
            </div>
            
            <div class="flex items-center gap-4">
                <button onclick="toggleLanguage()" class="text-xs font-bold px-3 py-1.5 rounded-full border border-stone-300 hover:bg-stone-100 transition text-stone-600">
                    ğŸŒ <span id="lang-display">EN</span>
                </button>
                <div class="hidden md:block text-xs font-medium text-stone-400 bg-stone-100 px-3 py-1.5 rounded-full">
                    <span data-i18n="privacy_tag">ğŸ”’ æœ¬åœ°å¤„ç†ï¼Œä¸ä¸Šä¼  / Private & Local</span>
                </div>
            </div>
        </div>
    </header>

    <main class="flex-grow max-w-6xl mx-auto w-full p-6 grid grid-cols-1 md:grid-cols-12 gap-8 mt-4">
        
        <aside class="md:col-span-3">
            <h3 class="font-bold text-stone-400 text-xs uppercase mb-4 tracking-wider px-2" data-i18n="menu_title">TOOLS / åŠŸèƒ½èœå•</h3>
            <nav class="space-y-1">
                <button onclick="switchTab('mp4')" id="btn-mp4" class="nav-btn active">
                    <span class="mr-3 text-lg">ğŸ”„</span> 
                    <div class="text-left leading-tight">
                        <div class="text-sm" data-i18n="btn_mp4">è§†é¢‘è½¬ MP4</div>
                        <div class="text-[10px] opacity-60 font-normal" data-i18n="desc_mp4">Fix Format</div>
                    </div>
                </button>
                <button onclick="switchTab('compress')" id="btn-compress" class="nav-btn">
                    <span class="mr-3 text-lg">ğŸ“‰</span> 
                    <div class="text-left leading-tight">
                        <div class="text-sm" data-i18n="btn_compress">å¾®ä¿¡è§†é¢‘å‹ç¼©</div>
                        <div class="text-[10px] opacity-60 font-normal" data-i18n="desc_compress">Reduce Size</div>
                    </div>
                </button>
                <button onclick="switchTab('trim')" id="btn-trim" class="nav-btn">
                    <span class="mr-3 text-lg">âœ‚ï¸</span> 
                    <div class="text-left leading-tight">
                        <div class="text-sm" data-i18n="btn_trim">è§†é¢‘æå¤´å»å°¾</div>
                        <div class="text-[10px] opacity-60 font-normal" data-i18n="desc_trim">Simple Trim</div>
                    </div>
                </button>
                <button onclick="switchTab('audio')" id="btn-audio" class="nav-btn">
                    <span class="mr-3 text-lg">ğŸµ</span> 
                    <div class="text-left leading-tight">
                        <div class="text-sm" data-i18n="btn_audio">æå–éŸ³é¢‘</div>
                        <div class="text-[10px] opacity-60 font-normal" data-i18n="desc_audio">Get MP3</div>
                    </div>
                </button>
                <button onclick="switchTab('heic')" id="btn-heic" class="nav-btn">
                    <span class="mr-3 text-lg">ğŸ–¼ï¸</span> 
                    <div class="text-left leading-tight">
                        <div class="text-sm" data-i18n="btn_heic">è‹¹æœå›¾ç‰‡è½¬æ¢</div>
                        <div class="text-[10px] opacity-60 font-normal" data-i18n="desc_heic">HEIC to JPG</div>
                    </div>
                </button>
            </nav>
        </aside>

        <section class="md:col-span-9">
            
            <div class="mb-6 p-6 rounded-2xl bg-[#EBECE9] text-stone-700 text-sm border border-stone-200">
                <div id="instruction-text">Loading...</div>
            </div>

            <div class="morandi-card p-10 min-h-[450px] flex flex-col justify-center items-center text-center relative overflow-hidden">
                
                <div id="upload-zone" class="w-full max-w-xl transition-all duration-500">
                    <label class="upload-box block p-16 cursor-pointer group">
                        <div class="text-5xl mb-4 opacity-50 group-hover:scale-110 transition-transform duration-300">ğŸ“‚</div>
                        <h3 class="font-bold text-lg text-stone-700 mb-1" data-i18n="upload_title">ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</h3>
                        <p class="text-stone-400 text-sm" id="file-hint">MOV, MKV, MP4, AVI...</p>
                        <input type="file" id="file-input" class="hidden">
                    </label>
                </div>

                <div id="options-zone" class="hidden w-full max-w-md mt-8 bg-stone-50 p-6 rounded-xl border border-stone-200 text-left animate-fade-in">
                    <div id="opt-trim" class="hidden grid grid-cols-2 gap-5">
                        <div>
                            <label class="text-xs font-bold text-stone-500 mb-1 block" data-i18n="trim_start">å¼€å§‹æ—¶é—´ (ç§’)</label>
                            <input type="number" id="trim-start" value="0" class="w-full p-2 border border-stone-300 rounded-lg focus:outline-none focus:border-[#709085]" placeholder="0">
                        </div>
                        <div>
                            <label class="text-xs font-bold text-stone-500 mb-1 block" data-i18n="trim_duration">æŒç»­æ—¶é—´ (ç§’)</label>
                            <input type="number" id="trim-duration" class="w-full p-2 border border-stone-300 rounded-lg focus:outline-none focus:border-[#709085]" placeholder="10">
                        </div>
                    </div>
                </div>

                <div id="process-zone" class="hidden w-full max-w-md">
                    <div class="flex justify-center mb-6"><div class="loader scale-150"></div></div>
                    <h3 class="text-xl font-bold text-stone-700" id="status-text">Processing...</h3>
                    <p class="text-stone-400 text-sm mt-2" data-i18n="wait_hint">Browser is working hard, please wait...</p>
                </div>

                <div id="result-zone" class="hidden w-full animate-fade-in">
                    <div class="text-6xl mb-4 text-[#709085]">âœ¨</div>
                    <h3 class="text-2xl font-bold text-stone-800 mb-2" data-i18n="done_title">æå®šï¼</h3>
                    <p class="text-stone-500 mb-8" data-i18n="done_desc">Your file is ready.</p>
                    
                    <div class="flex flex-col gap-4 justify-center items-center">
                        <a id="download-link" href="#" class="btn-primary px-10 py-3 rounded-full font-bold shadow-lg flex items-center gap-2">
                            <span>â¬‡ï¸</span> <span data-i18n="download_btn">ä¸‹è½½æ–‡ä»¶</span>
                        </a>
                        <button onclick="location.reload()" class="text-stone-400 text-sm hover:text-stone-600 underline" data-i18n="next_btn">å¤„ç†ä¸‹ä¸€ä¸ª</button>
                    </div>
                </div>

                <div id="error-msg" class="hidden mt-6 bg-red-50 text-red-600 p-4 rounded-xl text-sm font-medium border border-red-100 max-w-lg"></div>
                
                <button id="start-btn" class="hidden mt-8 btn-primary px-12 py-3 rounded-full font-bold w-full max-w-xs mx-auto shadow-md" data-i18n="start_btn">
                    å¼€å§‹å¤„ç†
                </button>

            </div>
        </section>
    </main>

    <footer class="bg-white border-t border-stone-200 mt-12 py-12">
        <div class="max-w-6xl mx-auto px-6 grid grid-cols-1 md:grid-cols-2 gap-12 items-center">
            
            <div class="text-center md:text-left">
                <h3 class="text-xs font-bold text-stone-400 uppercase tracking-widest mb-4">Creator / åˆ›ä½œè€…</h3>
                <div class="flex flex-col md:flex-row items-center gap-4">
                     <div class="w-12 h-12 bg-stone-200 rounded-full flex items-center justify-center text-xl">ğŸ°</div>
                     <div>
                        <p class="text-xl font-bold text-stone-800">rabbitlin</p>
                        <p class="text-sm text-stone-500 font-mono">WeChat: Aa272123071</p>
                     </div>
                </div>
                
                <a href="https://github.com/rabbitlin-web/video-helper" target="_blank" class="mt-6 inline-flex items-center gap-2 px-5 py-2.5 bg-stone-800 text-white rounded-lg hover:bg-black transition text-sm font-medium">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
                    <span data-i18n="github_btn">Star on GitHub</span>
                </a>
            </div>

            <div class="relative group">
                <div class="absolute -inset-1 bg-gradient-to-r from-pink-100 to-purple-100 rounded-2xl blur opacity-50 group-hover:opacity-100 transition duration-1000"></div>
                <div class="relative bg-white rounded-xl p-6 border border-stone-100 shadow-sm flex items-center gap-6">
                    <img src="pay.jpg" alt="Donate" class="w-24 h-24 rounded-lg object-cover shadow-inner border border-stone-100">
                    <div>
                        <p class="font-bold text-stone-800 text-lg mb-1" data-i18n="coffee_title">â˜•ï¸ ä¹°æ¯å’–å•¡ï¼Ÿ</p>
                        <p class="text-sm text-stone-500 mb-2 leading-relaxed" data-i18n="coffee_desc">å¦‚æœè¿™ä¸ªå·¥å…·å¸®åˆ°äº†ä½ ï¼Œ<br>æ¬¢è¿æ”¯æŒä¸€ä¸‹æœåŠ¡å™¨(å¹¶æ²¡æœ‰)çš„ç”µè´¹ã€‚</p>
                        <p class="text-xs text-pink-500 font-medium">WeChat Pay / å¾®ä¿¡æ”¯ä»˜</p>
                    </div>
                </div>
            </div>

        </div>
    </footer>

    <script>
        // --- 1. è¯­è¨€åŒ…ä¸å›½é™…åŒ–é€»è¾‘ (i18n) ---
        const translations = {
            cn: {
                menu_title: "åŠŸèƒ½èœå• / TOOLS",
                privacy_tag: "ğŸ”’ æœ¬åœ°å¤„ç†ï¼Œä¸ä¸Šä¼  / Private & Local",
                btn_mp4: "è§†é¢‘è½¬ MP4", desc_mp4: "ä¿®å¤æ‰“ä¸å¼€çš„é—®é¢˜",
                btn_compress: "å¾®ä¿¡è§†é¢‘å‹ç¼©", desc_compress: "å¼ºåŠ›ç˜¦èº«å‘å¾®ä¿¡",
                btn_trim: "è§†é¢‘æå¤´å»å°¾", desc_trim: "ç®€å•ç²¾ç¡®å‰ªè¾‘",
                btn_audio: "æå–éŸ³é¢‘", desc_audio: "è§†é¢‘è½¬ MP3",
                btn_heic: "è‹¹æœå›¾ç‰‡è½¬æ¢", desc_heic: "HEIC è½¬ JPG",
                upload_title: "ç‚¹å‡»é€‰æ‹©æ–‡ä»¶",
                file_hint_video: "æ”¯æŒ MOV, MKV, MP4, AVI ç­‰",
                file_hint_heic: "è¯·é€‰æ‹© .heic / .heif å›¾ç‰‡",
                start_btn: "å¼€å§‹å¤„ç†",
                wait_hint: "æµè§ˆå™¨æ­£åœ¨å…¨åŠ›è®¡ç®—ä¸­ï¼Œè¯·è€å¿ƒç­‰å¾…...",
                done_title: "æå®šå•¦ï¼",
                done_desc: "æ–‡ä»¶å¤„ç†å®Œæˆï¼Œè¯·ç‚¹å‡»ä¸‹è½½ã€‚",
                download_btn: "ä¸‹è½½æ–‡ä»¶",
                next_btn: "å¤„ç†ä¸‹ä¸€ä¸ª",
                github_btn: "å» GitHub ç‚¹èµ",
                coffee_title: "â˜•ï¸ å–œæ¬¢è¿™ä¸ªå·¥å…·ï¼Ÿ",
                coffee_desc: "å¦‚æœè§‰å¾—å¥½ç”¨ï¼Œ<br>è¯·æˆ‘å–æ¯å’–å•¡ææç¥å§ï¼",
                trim_start: "å¼€å§‹æ—¶é—´ (ç§’)", trim_duration: "æŒç»­æ—¶é—´ (ç§’)",
                
                // è¯´æ˜ä¹¦æ–‡æ¡ˆ
                instr_mp4: "ğŸ’¡ <strong>åŠŸèƒ½è¯´æ˜ï¼š</strong> ä¸“é—¨è§£å†³è§†é¢‘æ‰“ä¸å¼€ã€é»‘å±æˆ–æ ¼å¼ä¸æ”¯æŒçš„é—®é¢˜ã€‚ä¸ç®¡åŸè§†é¢‘æ˜¯ä»€ä¹ˆå¤æ€ªæ ¼å¼ï¼Œç»Ÿç»Ÿè½¬æˆæœ€é€šç”¨çš„ MP4ã€‚",
                instr_compress: "ğŸ’¡ <strong>åŠŸèƒ½è¯´æ˜ï¼š</strong> å¾®ä¿¡é™åˆ¶æ–‡ä»¶å¤§å°ï¼Ÿç”¨è¿™ä¸ªã€‚å®ƒä¼šç¨å¾®é™ä½ä¸€ç‚¹ç”»è´¨ï¼ˆè‚‰çœ¼å‡ ä¹çœ‹ä¸å‡ºï¼‰ï¼Œä½†èƒ½æŠŠä½“ç§¯å‹å¾—å¾ˆå°ã€‚",
                instr_trim: "ğŸ’¡ <strong>åŠŸèƒ½è¯´æ˜ï¼š</strong> è§†é¢‘å‰é¢ 5 ç§’åœ¨è°ƒæ•´é•œå¤´ï¼Ÿè¿™é‡Œè¾“å…¥å¼€å§‹æ—¶é—´å’ŒæŒç»­æ—¶é•¿ï¼Œç²¾å‡†åˆ‡æ‰åºŸç‰‡ã€‚",
                instr_audio: "ğŸ’¡ <strong>åŠŸèƒ½è¯´æ˜ï¼š</strong> åªè¦å£°éŸ³ï¼Œä¸è¦ç”»é¢ã€‚æŠŠè§†é¢‘é‡Œçš„è®²è¯æˆ–éŸ³ä¹æå–å‡ºæ¥ï¼Œç”Ÿæˆ MP3ã€‚",
                instr_heic: "ğŸ’¡ <strong>åŠŸèƒ½è¯´æ˜ï¼š</strong> è‹¹æœæ‰‹æœºæ‹çš„ç…§ç‰‡åœ¨ç”µè„‘ä¸Šæ‰“ä¸å¼€ï¼Ÿç”¨è¿™ä¸ªä¸€é”®è½¬æˆ JPGã€‚"
            },
            en: {
                menu_title: "TOOLS MENU",
                privacy_tag: "ğŸ”’ 100% Local Processing",
                btn_mp4: "Convert to MP4", desc_mp4: "Fix playback issues",
                btn_compress: "Compress Video", desc_compress: "For WeChat/WhatsApp",
                btn_trim: "Trim Video", desc_trim: "Cut start/end",
                btn_audio: "Extract Audio", desc_audio: "Get MP3 file",
                btn_heic: "HEIC to JPG", desc_heic: "Fix iPhone Photos",
                upload_title: "Click to Upload",
                file_hint_video: "Supports MOV, MKV, MP4, AVI...",
                file_hint_heic: "Select .heic / .heif image",
                start_btn: "Start Processing",
                wait_hint: "Browser is processing locally, please wait...",
                done_title: "All Done!",
                done_desc: "Your file is ready for download.",
                download_btn: "Download File",
                next_btn: "Process Another",
                github_btn: "Star on GitHub",
                coffee_title: "â˜•ï¸ Buy me a coffee?",
                coffee_desc: "If this tool saved your time,<br>feel free to support me!",
                trim_start: "Start Time (sec)", trim_duration: "Duration (sec)",

                instr_mp4: "ğŸ’¡ <strong>Info:</strong> Fixes videos that won't open or play nicely. Converts any format to standard MP4.",
                instr_compress: "ğŸ’¡ <strong>Info:</strong> File too big for email or WeChat? This reduces file size significantly with minimal quality loss.",
                instr_trim: "ğŸ’¡ <strong>Info:</strong> Cut out the boring parts. Enter start time and duration to trim your video.",
                instr_audio: "ğŸ’¡ <strong>Info:</strong> Want just the music or speech? Extracts audio track to MP3.",
                instr_heic: "ğŸ’¡ <strong>Info:</strong> Windows can't open iPhone photos? Convert HEIC to standard JPG instantly."
            }
        };

        let currentLang = 'cn'; // é»˜è®¤ä¸­æ–‡

        function toggleLanguage() {
            currentLang = currentLang === 'cn' ? 'en' : 'cn';
            document.getElementById('lang-display').innerText = currentLang === 'cn' ? 'EN' : 'ä¸­';
            updateUIText();
            updateInstructions(); // åˆ·æ–°è¯´æ˜ä¹¦
        }

        function updateUIText() {
            const data = translations[currentLang];
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (data[key]) el.innerHTML = data[key];
            });
            // åˆ·æ–°æ–‡ä»¶æç¤º
            if (currentMode === 'heic') {
                els.fileHint.innerText = data.file_hint_heic;
            } else {
                els.fileHint.innerText = data.file_hint_video;
            }
        }

        // --- 2. è§†é¢‘å¤„ç†æ ¸å¿ƒé€»è¾‘ (FFmpeg) ---
        const { createFFmpeg, fetchFile } = FFmpeg;
        const ffmpeg = createFFmpeg({ log: true });
        
        let currentMode = 'mp4';
        let selectedFile = null;

        const els = {
            uploadZone: document.getElementById('upload-zone'),
            processZone: document.getElementById('process-zone'),
            resultZone: document.getElementById('result-zone'),
            optionsZone: document.getElementById('options-zone'),
            optTrim: document.getElementById('opt-trim'),
            fileInput: document.getElementById('file-input'),
            startBtn: document.getElementById('start-btn'),
            statusText: document.getElementById('status-text'),
            downloadLink: document.getElementById('download-link'),
            errorMsg: document.getElementById('error-msg'),
            instruction: document.getElementById('instruction-text'),
            fileHint: document.getElementById('file-hint')
        };

        // åˆå§‹åŒ–
        updateUIText();
        updateInstructions();

        window.switchTab = (mode) => {
            currentMode = mode;
            // æ ·å¼åˆ‡æ¢
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`btn-${mode}`).classList.add('active');
            
            resetUI();
            updateInstructions();
            updateUIText(); // ç¡®ä¿æç¤ºæ–‡æ¡ˆæ­£ç¡®
            
            if (mode === 'heic') {
                els.fileInput.accept = "image/heic, image/heif";
            } else {
                els.fileInput.accept = "video/*";
            }
        };

        function updateInstructions() {
            const t = translations[currentLang];
            const map = {
                mp4: t.instr_mp4,
                compress: t.instr_compress,
                trim: t.instr_trim,
                audio: t.instr_audio,
                heic: t.instr_heic
            };
            els.instruction.innerHTML = map[currentMode];

            // æ˜¾ç¤ºå‰ªè¾‘é€‰é¡¹
            if(currentMode === 'trim') {
                els.optionsZone.classList.remove('hidden');
                els.optTrim.classList.remove('hidden');
            } else {
                els.optionsZone.classList.add('hidden');
                els.optTrim.classList.add('hidden');
            }
        }

        function resetUI() {
            selectedFile = null;
            els.fileInput.value = "";
            els.uploadZone.classList.remove('hidden');
            els.processZone.classList.add('hidden');
            els.resultZone.classList.add('hidden');
            els.startBtn.classList.add('hidden');
            els.errorMsg.classList.add('hidden');
        }

        els.fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            selectedFile = file;
            els.fileHint.innerHTML = `Selected: <strong class="text-stone-800">${file.name}</strong>`;
            els.startBtn.classList.remove('hidden');
        });

        els.startBtn.addEventListener('click', async () => {
            if (!selectedFile) return;
            els.uploadZone.classList.add('hidden');
            els.optionsZone.classList.add('hidden');
            els.startBtn.classList.add('hidden');
            els.processZone.classList.remove('hidden');
            els.errorMsg.classList.add('hidden');

            try {
                if (currentMode === 'heic') {
                    await processHEIC(selectedFile);
                } else {
                    await processVideo(selectedFile);
                }
            } catch (err) {
                console.error(err);
                els.processZone.classList.add('hidden');
                els.uploadZone.classList.remove('hidden');
                els.errorMsg.innerHTML = "Error: " + err.message + "<br><span class='text-xs text-stone-400'>Check SharedArrayBuffer / HTTPS settings.</span>";
                els.errorMsg.classList.remove('hidden');
            }
        });

        async function processHEIC(file) {
            els.statusText.innerText = currentLang === 'cn' ? "æ­£åœ¨è½¬æ¢å›¾ç‰‡..." : "Converting Image...";
            const blob = await heic2any({ blob: file, toType: "image/jpeg", quality: 0.8 });
            const url = URL.createObjectURL(blob);
            els.downloadLink.href = url;
            els.downloadLink.download = file.name.replace(/\.(heic|heif)$/i, "") + ".jpg";
            finishProcess();
        }

        async function processVideo(file) {
            if (!ffmpeg.isLoaded()) {
                els.statusText.innerText = currentLang === 'cn' ? "æ­£åœ¨åŠ è½½å¼•æ“..." : "Loading Engine...";
                await ffmpeg.load();
            }

            try { ffmpeg.FS('unlink', 'input_video'); ffmpeg.FS('unlink', 'output.mp4'); } catch(e){}

            const fileName = 'input_video';
            ffmpeg.FS('writeFile', fileName, await fetchFile(file));

            els.statusText.innerText = currentLang === 'cn' ? "æ­£åœ¨å¤„ç†ä¸­..." : "Processing...";

            let command = [];
            const outputName = 'output.mp4';
            let finalOutput = outputName;
            const commonFlags = ['-pix_fmt', 'yuv420p', '-movflags', '+faststart'];

            if (currentMode === 'mp4') {
                command = ['-i', fileName, '-c:v', 'libx264', '-preset', 'superfast', '-crf', '23', '-c:a', 'aac', ...commonFlags, outputName];
            } 
            else if (currentMode === 'compress') {
                command = ['-i', fileName, '-vf', 'scale=-2:720', '-c:v', 'libx264', '-crf', '30', '-preset', 'superfast', '-c:a', 'aac', '-b:a', '96k', ...commonFlags, outputName];
            }
            else if (currentMode === 'audio') {
                finalOutput = 'output.mp3';
                command = ['-i', fileName, '-vn', '-acodec', 'libmp3lame', '-q:a', '4', finalOutput];
            }
            else if (currentMode === 'trim') {
                const start = document.getElementById('trim-start').value || 0;
                const duration = document.getElementById('trim-duration').value;
                let cmdBuilder = ['-ss', start, '-i', fileName];
                if (duration) cmdBuilder.push('-t', duration);
                command = [...cmdBuilder, '-c:v', 'libx264', '-preset', 'superfast', '-c:a', 'aac', ...commonFlags, outputName];
            }

            await ffmpeg.run(...command);

            const data = ffmpeg.FS('readFile', finalOutput);
            const url = URL.createObjectURL(new Blob([data.buffer], { type: currentMode === 'audio' ? 'audio/mp3' : 'video/mp4' }));
            
            els.downloadLink.href = url;
            els.downloadLink.download = `fixed_${file.name.split('.')[0]}.${currentMode === 'audio' ? 'mp3' : 'mp4'}`;
            
            finishProcess();
        }

        function finishProcess() {
            els.processZone.classList.add('hidden');
            els.resultZone.classList.remove('hidden');
        }
    </script>
</body>
</html>
