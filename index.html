<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°ç™½è§†é¢‘åŠ©æ‰‹ | VideoHelper - By rabbitlin</title>
    <meta name="description" content="ä¸“ä¸ºæ–°æ‰‹è®¾è®¡çš„è§†é¢‘å·¥å…·ç®±ã€‚å…è´¹è½¬æ¢MP4ï¼Œå‹ç¼©è§†é¢‘å‘å¾®ä¿¡ã€‚Created by rabbitlin.">
    
    <script src="https://cdn.tailwindcss.com"></script>

    <script src="coi-serviceworker.js"></script>

    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.10.0/dist/ffmpeg.min.js"></script>

    <script src="https://unpkg.com/heic2any@0.0.3/dist/heic2any.min.js"></script>
    
    <style>
        body { background-color: #f2f2f2; color: #111; }
        
        /* æŒ‰é’®é€šç”¨é£æ ¼ */
        .btn-tool { transition: all 0.2s; border: 2px solid #000; background: #fff; }
        .btn-tool:hover { transform: translate(-2px, -2px); box-shadow: 4px 4px 0px #000; }
        .btn-tool.active { background: #000; color: #fff; box-shadow: 4px 4px 0px #666; transform: translate(-2px, -2px); }
        
        /* Github æŒ‰é’®é£æ ¼ */
        .btn-github { background: #000; color: #fff; border: 2px solid #000; }
        .btn-github:hover { background: #333; transform: translate(-2px, -2px); box-shadow: 4px 4px 0px rgba(0,0,0,0.2); }

        .panel { border: 2px solid #000; background: #fff; box-shadow: 8px 8px 0px rgba(0,0,0,0.1); }
        .input-box { border: 2px solid #ccc; border-radius: 4px; padding: 8px; width: 100%; }
        .input-box:focus { border-color: #000; outline: none; }
        
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #000; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="font-sans antialiased min-h-screen flex flex-col">

    <header class="bg-white border-b-2 border-black p-6">
        <div class="max-w-6xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
            <div>
                <h1 class="text-3xl font-black tracking-tighter uppercase">VIDEO<span class="text-gray-500">HELPER</span></h1>
                <p class="text-sm font-bold text-gray-500 mt-1">ä¸æ‡‚ç”µè„‘ä¹Ÿèƒ½ç”¨çš„è§†é¢‘å·¥å…·ç®± <span class="text-xs bg-black text-white px-1 rounded">V2.0</span></p>
            </div>
            <div class="text-xs font-mono bg-gray-100 px-3 py-1 border border-gray-300 rounded">
                éšç§ä¿æŠ¤ï¼šæœ¬åœ°å¤„ç†ï¼Œä¸ä¸Šä¼ æœåŠ¡å™¨ / Private & Local
            </div>
        </div>
    </header>

    <main class="flex-grow max-w-6xl mx-auto w-full p-6 grid grid-cols-1 md:grid-cols-4 gap-8">
        <aside class="md:col-span-1 space-y-3">
            <h3 class="font-bold text-gray-400 text-sm uppercase mb-4">åŠŸèƒ½èœå• / TOOLS</h3>
            <button onclick="switchTab('mp4')" id="btn-mp4" class="btn-tool active w-full py-4 px-4 text-left font-bold flex items-center justify-between"><span>ğŸ”„ è§†é¢‘è½¬ MP4</span> <span class="text-xs opacity-50">ä¿®å¤æ‰“ä¸å¼€</span></button>
            <button onclick="switchTab('compress')" id="btn-compress" class="btn-tool w-full py-4 px-4 text-left font-bold flex items-center justify-between"><span>ğŸ“‰ å¾®ä¿¡è§†é¢‘å‹ç¼©</span> <span class="text-xs opacity-50">å¼ºåŠ›ç˜¦èº«</span></button>
            <button onclick="switchTab('trim')" id="btn-trim" class="btn-tool w-full py-4 px-4 text-left font-bold flex items-center justify-between"><span>âœ‚ï¸ è§†é¢‘æå¤´å»å°¾</span> <span class="text-xs opacity-50">ç²¾ç¡®å‰ªè¾‘</span></button>
            <button onclick="switchTab('audio')" id="btn-audio" class="btn-tool w-full py-4 px-4 text-left font-bold flex items-center justify-between"><span>ğŸµ æå–éŸ³é¢‘</span> <span class="text-xs opacity-50">è½¬MP3</span></button>
            <button onclick="switchTab('heic')" id="btn-heic" class="btn-tool w-full py-4 px-4 text-left font-bold flex items-center justify-between"><span>ğŸ–¼ï¸ è‹¹æœå›¾ç‰‡è½¬æ¢</span> <span class="text-xs opacity-50">HEICè½¬JPG</span></button>
        </aside>

        <section class="md:col-span-3">
            <div id="instruction-panel" class="mb-6 p-4 bg-gray-100 border-l-4 border-black text-sm text-gray-700"></div>

            <div class="panel p-8 min-h-[400px] flex flex-col justify-center items-center text-center relative">
                <div id="upload-zone" class="w-full">
                    <label class="block w-full border-2 border-dashed border-gray-300 hover:border-black hover:bg-gray-50 p-12 rounded-lg cursor-pointer transition">
                        <div class="text-4xl mb-2">ğŸ“‚</div>
                        <span class="font-bold text-lg">ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</span>
                        <p class="text-gray-400 text-sm mt-2" id="file-hint">æ”¯æŒ MOV, AVI, MKV ç­‰</p>
                        <input type="file" id="file-input" class="hidden">
                    </label>
                </div>

                <div id="options-zone" class="hidden w-full max-w-md mt-6 bg-gray-50 p-4 border border-gray-200 rounded text-left">
                    <div id="opt-trim" class="hidden grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-xs font-bold">å¼€å§‹æ—¶é—´ (ç§’)</label>
                            <input type="number" id="trim-start" value="0" class="input-box" placeholder="ä¾‹å¦‚: 5">
                        </div>
                        <div>
                            <label class="text-xs font-bold">æŒç»­æ—¶é—´ (ç§’)</label>
                            <input type="number" id="trim-duration" class="input-box" placeholder="ä¾‹å¦‚: 10">
                        </div>
                    </div>
                </div>

                <div id="process-zone" class="hidden w-full">
                    <div class="loader mb-4"></div>
                    <h3 class="text-xl font-bold" id="status-text">å‡†å¤‡å°±ç»ª...</h3>
                    <p class="text-gray-500 text-sm mt-2">æµè§ˆå™¨æ­£åœ¨å…¨åŠ›è®¡ç®—ä¸­ï¼Œç”µè„‘å‘çƒ­æ˜¯æ­£å¸¸çš„...</p>
                </div>

                <div id="result-zone" class="hidden w-full">
                    <div class="text-5xl mb-4">âœ…</div>
                    <h3 class="text-2xl font-bold mb-2">æå®šï¼</h3>
                    <div class="flex flex-col gap-3 justify-center mt-6">
                        <a id="download-link" href="#" class="bg-black text-white px-8 py-3 font-bold hover:bg-gray-800 transition rounded shadow-lg">â¬‡ï¸ ä¸‹è½½æ–‡ä»¶</a>
                        <button onclick="location.reload()" class="text-gray-500 underline text-sm">åˆ·æ–°é¡µé¢å¤„ç†ä¸‹ä¸€ä¸ª</button>
                    </div>
                </div>

                <div id="error-msg" class="hidden mt-4 bg-red-50 text-red-600 p-3 text-sm font-bold border border-red-200"></div>
                
                <button id="start-btn" class="hidden mt-6 bg-black text-white px-10 py-3 font-bold hover:bg-gray-800 w-full max-w-xs mx-auto">å¼€å§‹å¤„ç†</button>
            </div>
        </section>
    </main>

    <footer class="bg-white border-t-2 border-black mt-12">
        <div class="max-w-6xl mx-auto p-8 grid grid-cols-1 md:grid-cols-2 gap-10 items-center">
            
            <div class="text-center md:text-left space-y-4">
                <div>
                    <h3 class="text-xl font-black uppercase tracking-wider">About Creator</h3>
                    <p class="text-lg font-bold mt-2">åˆ›ä½œè€…ï¼š<span class="bg-black text-white px-1">rabbitlin</span></p>
                    <p class="text-gray-500 font-mono text-sm">å¾®ä¿¡å· (WeChat): Aa272123071</p>
                </div>
                
                <a href="https://github.com/rabbitlin-web/video-helper" target="_blank" class="btn-github inline-flex items-center px-6 py-3 font-bold rounded-lg transition mt-4">
                    <span class="mr-2 text-xl">â­</span> 
                    <span>Star on GitHub / å»ç‚¹èµ</span>
                </a>
                <p class="text-xs text-gray-400 mt-2">æºä»£ç å¼€æºï¼Œæ¬¢è¿ Fork å’Œ å­¦ä¹ ã€‚</p>
            </div>

            <div class="bg-gray-50 border-2 border-dashed border-gray-300 rounded-xl p-6 text-center">
                <p class="font-bold text-gray-800 mb-2">
                    â˜•ï¸ å–œæ¬¢è¿™ä¸ªå·¥å…·å—ï¼Ÿ<br>
                    <span class="text-sm font-normal text-gray-500">If you like it, buy me a coffee!</span>
                </p>
                <p class="text-sm text-pink-500 font-bold mb-4">
                    "å¦‚æœè§‰å¾—å¥½ç”¨ï¼Œè¯·æˆ‘å–æ¯å’–å•¡ææç¥å§ï¼"
                </p>
                
                <img src="pay.jpg" alt="WeChat Pay" class="w-40 h-40 object-cover mx-auto rounded-lg border border-gray-200 shadow-sm">
                
                <p class="text-xs text-gray-400 mt-2">WeChat Pay / å¾®ä¿¡æ”¯ä»˜</p>
            </div>

        </div>
    </footer>

    <script>
        const { createFFmpeg, fetchFile } = FFmpeg;
        const ffmpeg = createFFmpeg({ log: true });
        
        let currentMode = 'mp4';
        let selectedFile = null;

        const els = {
            uploadZone: document.getElementById('upload-zone'),
            processZone: document.getElementById('process-zone'),
            resultZone: document.getElementById('result-zone'),
            optionsZone: document.getElementById('options-zone'),
            optTrim: document.getElementById('opt-trim'),
            fileInput: document.getElementById('file-input'),
            startBtn: document.getElementById('start-btn'),
            statusText: document.getElementById('status-text'),
            downloadLink: document.getElementById('download-link'),
            errorMsg: document.getElementById('error-msg'),
            instruction: document.getElementById('instruction-panel'),
            fileHint: document.getElementById('file-hint')
        };

        const instructions = {
            mp4: `<strong>ğŸ“¢ ä¿®å¤/è½¬æ¢:</strong> è§£å†³è§†é¢‘æ— æ³•æ’­æ”¾ã€é»‘å±ã€æ ¼å¼ä¸æ”¯æŒçš„é—®é¢˜ã€‚è¾“å‡ºæ ‡å‡† MP4ã€‚`,
            compress: `<strong>ğŸ“¢ å¼ºåŠ›å‹ç¼©:</strong> ä¸“é—¨è§£å†³å¾®ä¿¡/é‚®ä»¶å‘ä¸å‡ºçš„é—®é¢˜ã€‚<br>æˆ‘ä»¬ä¼šå¤§å¹…å‹ç¼©ç”»è´¨ä»¥æ¢å–æœ€å°ä½“ç§¯ï¼ˆCRF 30ï¼‰ã€‚`,
            trim: `<strong>ğŸ“¢ ç²¾ç¡®å‰ªè¾‘:</strong> è¾“å…¥å¼€å§‹æ—¶é—´å’ŒæŒç»­æ—¶é•¿ã€‚<br>æˆ‘ä»¬ä¼šé‡æ–°ç¼–ç ä»¥ç¡®ä¿å‰ªè¾‘ç‚¹ç²¾ç¡®ï¼ˆå¯èƒ½ä¼šæ…¢ä¸€ç‚¹ï¼‰ã€‚`,
            audio: `<strong>ğŸ“¢ æå–éŸ³é¢‘:</strong> ä»…æå–å£°éŸ³ï¼Œç”Ÿæˆ MP3 æ–‡ä»¶ã€‚`,
            heic: `<strong>ğŸ“¢ å›¾ç‰‡è½¬æ¢:</strong> iPhone ç…§ç‰‡è½¬ JPGã€‚`
        };

        updateInstructions();

        window.switchTab = (mode) => {
            currentMode = mode;
            document.querySelectorAll('.btn-tool').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`btn-${mode}`).classList.add('active');
            resetUI();
            updateInstructions();
            if (mode === 'heic') {
                els.fileInput.accept = "image/heic, image/heif";
                els.fileHint.innerText = "è¯·é€‰æ‹© .heic å›¾ç‰‡";
            } else {
                els.fileInput.accept = "video/*";
                els.fileHint.innerText = "æ”¯æŒå„ç§è§†é¢‘æ ¼å¼";
            }
        };

        function updateInstructions() {
            els.instruction.innerHTML = instructions[currentMode];
            if(currentMode === 'trim') {
                els.optionsZone.classList.remove('hidden');
                els.optTrim.classList.remove('hidden');
            } else {
                els.optionsZone.classList.add('hidden');
                els.optTrim.classList.add('hidden');
            }
        }

        function resetUI() {
            selectedFile = null;
            els.fileInput.value = "";
            els.uploadZone.classList.remove('hidden');
            els.processZone.classList.add('hidden');
            els.resultZone.classList.add('hidden');
            els.startBtn.classList.add('hidden');
            els.errorMsg.classList.add('hidden');
        }

        els.fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            selectedFile = file;
            els.fileHint.innerHTML = `å·²é€‰æ‹©ï¼š<strong class="text-black">${file.name}</strong> (${(file.size/1024/1024).toFixed(1)} MB)`;
            els.startBtn.classList.remove('hidden');
        });

        els.startBtn.addEventListener('click', async () => {
            if (!selectedFile) return;
            els.uploadZone.classList.add('hidden');
            els.optionsZone.classList.add('hidden');
            els.startBtn.classList.add('hidden');
            els.processZone.classList.remove('hidden');
            els.errorMsg.classList.add('hidden');

            try {
                if (currentMode === 'heic') {
                    await processHEIC(selectedFile);
                } else {
                    await processVideo(selectedFile);
                }
            } catch (err) {
                console.error(err);
                els.processZone.classList.add('hidden');
                els.uploadZone.classList.remove('hidden');
                els.errorMsg.innerHTML = "å‡ºé”™äº†ï¼š" + err.message + "<br>è¯·æ£€æŸ¥æ˜¯å¦å·²é…ç½®HTTPSæˆ–SharedArrayBufferã€‚";
                els.errorMsg.classList.remove('hidden');
            }
        });

        async function processHEIC(file) {
            els.statusText.innerText = "æ­£åœ¨è½¬æ¢å›¾ç‰‡...";
            const blob = await heic2any({ blob: file, toType: "image/jpeg", quality: 0.8 });
            const url = URL.createObjectURL(blob);
            els.downloadLink.href = url;
            els.downloadLink.download = file.name.replace(/\.(heic|heif)$/i, "") + ".jpg";
            finishProcess();
        }

        async function processVideo(file) {
            if (!ffmpeg.isLoaded()) {
                els.statusText.innerText = "æ­£åœ¨åŠ è½½å¼•æ“ (é¦–æ¬¡éœ€ç­‰å¾…)...";
                await ffmpeg.load();
            }

            try { ffmpeg.FS('unlink', 'input_video'); ffmpeg.FS('unlink', 'output.mp4'); } catch(e){}

            const fileName = 'input_video';
            ffmpeg.FS('writeFile', fileName, await fetchFile(file));

            els.statusText.innerText = "æ­£åœ¨å¤„ç†ä¸­ (è¯·å‹¿å…³é—­ç½‘é¡µ)...";

            let command = [];
            const outputName = 'output.mp4';
            let finalOutput = outputName;

            const commonFlags = ['-pix_fmt', 'yuv420p', '-movflags', '+faststart'];

            if (currentMode === 'mp4') {
                command = ['-i', fileName, '-c:v', 'libx264', '-preset', 'superfast', '-crf', '23', '-c:a', 'aac', ...commonFlags, outputName];
            } 
            else if (currentMode === 'compress') {
                command = ['-i', fileName, '-vf', 'scale=-2:720', '-c:v', 'libx264', '-crf', '30', '-preset', 'superfast', '-c:a', 'aac', '-b:a', '96k', ...commonFlags, outputName];
            }
            else if (currentMode === 'audio') {
                finalOutput = 'output.mp3';
                command = ['-i', fileName, '-vn', '-acodec', 'libmp3lame', '-q:a', '4', finalOutput];
            }
            else if (currentMode === 'trim') {
                const start = document.getElementById('trim-start').value || 0;
                const duration = document.getElementById('trim-duration').value;
                let cmdBuilder = ['-ss', start, '-i', fileName];
                if (duration) cmdBuilder.push('-t', duration);
                command = [...cmdBuilder, '-c:v', 'libx264', '-preset', 'superfast', '-c:a', 'aac', ...commonFlags, outputName];
            }

            await ffmpeg.run(...command);

            const data = ffmpeg.FS('readFile', finalOutput);
            const url = URL.createObjectURL(new Blob([data.buffer], { type: currentMode === 'audio' ? 'audio/mp3' : 'video/mp4' }));
            
            els.downloadLink.href = url;
            els.downloadLink.download = `fixed_${file.name.split('.')[0]}.${currentMode === 'audio' ? 'mp3' : 'mp4'}`;
            
            finishProcess();
        }

        function finishProcess() {
            els.processZone.classList.add('hidden');
            els.resultZone.classList.remove('hidden');
        }
    </script>
</body>
</html>
